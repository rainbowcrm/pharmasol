package com.primus.externals.doctor.dao;

import com.primus.abstracts.AbstractDAO;
import com.primus.abstracts.PrimusModel;
import com.primus.common.address.Address;
import com.primus.externals.doctor.model.DoctorAssociation;
import com.techtrade.rads.framework.utils.Utils;
import org.springframework.stereotype.Component;
import com.primus.externals.doctor.model.Doctor;

import javax.persistence.Query;
import java.util.ArrayList;
import java.util.List;

/**
** Class Generated by Primus Auto code generator
**/
@Component
public class DoctorDAO extends AbstractDAO{

  @Override
    public String getEntityClassName() {
        return  "Doctor";
    }

    @Override
    public Class getEntityClass() {
        return  Doctor.class;
    }


    public DoctorAssociation getAssociation (int doctorId, int companyId )
    {
        Query query =  em.createQuery("from DoctorAssociation where  company.id = :companyId and doctor.id = :doctorId " );
        query.setParameter("companyId", companyId);
        query.setParameter("doctorId", doctorId);
        List<DoctorAssociation> lst = query.getResultList();
        if(!Utils.isNullList(lst)) {
            return lst.get(0);
        }
        return null;
    }


    public void createAssociation(DoctorAssociation association)
    {
        em.merge(association) ;
    }

    public void updateAssociation(DoctorAssociation association)
    {
        em.merge(association) ;
    }



    public List<PrimusModel> listData(String table, int from , int to , String whereCondition, String orderby, int companyId ) {
        Query query =  em.createQuery("from " + table   +  ((Utils.isNull(whereCondition))?"":whereCondition) +
                " " + ((Utils.isNull(orderby))?"": (" order by " + orderby) ) );
        query.setFirstResult(from);
        query.setMaxResults(to-from);
        List<PrimusModel> ans = query.getResultList();
        if(!Utils.isNull(ans)) {
            ans.forEach( model ->  {
                Doctor doctor  =(Doctor) model ;
                DoctorAssociation association = getAssociation(doctor.getId(),companyId);
                if(association != null)
                    doctor.setAssociatedForCompany(association.getAssociated());
                else
                    doctor.setAssociatedForCompany(false);
            } );
        }

        return ans;

    }

   /* public List<PrimusModel> listData(String table, int from , int to , String whereCondition, String orderby, int companyId ) {
// left outer join  Doctor.address address  &&  address.city,address.phone ,
        Query query =  em.createQuery(" select Doctor.id, Doctor.code , Doctor.name,Doctor.contactPerson,   association.associated ,association.company.id " +
                "  from Doctor Doctor  left  join    Doctor.doctorAssociations association where association.company.id = " +  companyId + "     "  +  ((Utils.isNull(whereCondition))?"":whereCondition) +
                " " + ((Utils.isNull(orderby))?"": (" order by " + orderby) ) );
        query.setFirstResult(from);
        query.setMaxResults(to-from);
        List<Object[]> ans = query.getResultList();
        List<PrimusModel> results = new ArrayList<>();
        if(!Utils.isNull(ans)) {
            ans.forEach( objects ->  {
                int id = Integer.parseInt(String.valueOf(objects[0]));
                String associatedCompany = String.valueOf(objects[7]);
               // if(Utils.isNullString(associatedCompany) ||associatedCompany.equalsIgnoreCase(String.valueOf(companyId)) ) {
                    String code = String.valueOf(objects[1]);
                    String name = String.valueOf(objects[2]);
                    String contactPerson = String.valueOf(objects[3]);
                    String city = String.valueOf(objects[4]);
                    String phone = String.valueOf(objects[5]);
                    String associated = String.valueOf(objects[6]);
                    Doctor uiDoctor = new Doctor();
                    uiDoctor.setId(id);
                    uiDoctor.setCode(code);
                    uiDoctor.setName(name);
                    uiDoctor.setContactPerson(contactPerson);
                    uiDoctor.setAddress(new Address());
                    uiDoctor.getAddress().setCity(city);
                    uiDoctor.getAddress().setPhone(phone);
                    uiDoctor.setAssociatedForCompany(Boolean.valueOf(associated));
                    results.add(uiDoctor);
                //}


            } );
        }

        return results;
    }*/

}

