package com.primus.externals.store.dao;

import com.primus.abstracts.AbstractDAO;
import com.primus.abstracts.PrimusModel;
import com.primus.common.address.Address;
import com.primus.externals.store.model.StoreAssociation;
import com.techtrade.rads.framework.utils.Utils;
import org.springframework.stereotype.Component;
import com.primus.externals.store.model.Store;

import javax.persistence.Query;
import java.util.ArrayList;
import java.util.List;

/**
** Class Generated by Primus Auto code generator
**/
@Component
public class StoreDAO extends AbstractDAO{

  @Override
    public String getEntityClassName() {
        return  "Store";
    }

    @Override
    public Class getEntityClass() {
        return  Store.class;
    }


    public StoreAssociation getAssociation (int storeId, int companyId )
    {
        Query query =  em.createQuery("from StoreAssociation where  company.id = :companyId and store.id = :storeId " );
        query.setParameter("companyId", companyId);
        query.setParameter("storeId", storeId);
        List<StoreAssociation> lst = query.getResultList();
        if(!Utils.isNullList(lst)) {
            return lst.get(0);
        }
        return null;
    }


    public void createAssociation(StoreAssociation association)
    {
        em.merge(association) ;
    }

    public void updateAssociation(StoreAssociation association)
    {
        em.merge(association) ;
    }



    public List<PrimusModel> listData(String table, int from , int to , String whereCondition, String orderby, int companyId ) {
        Query query =  em.createQuery("from " + table   +  ((Utils.isNull(whereCondition))?"":whereCondition) +
                " " + ((Utils.isNull(orderby))?"": (" order by " + orderby) ) );
        query.setFirstResult(from);
        query.setMaxResults(to-from);
        List<PrimusModel> ans = query.getResultList();
        if(!Utils.isNull(ans)) {
            ans.forEach( model ->  {
                Store store  =(Store) model ;
                StoreAssociation association = getAssociation(store.getId(),companyId);
                if(association != null)
                    store.setAssociatedForCompany(association.getAssociated());
                else
                    store.setAssociatedForCompany(false);
            } );
        }

        return ans;

    }

   /* public List<PrimusModel> listData(String table, int from , int to , String whereCondition, String orderby, int companyId ) {
// left outer join  Store.address address  &&  address.city,address.phone ,
        Query query =  em.createQuery(" select Store.id, Store.code , Store.name,Store.contactPerson,   association.associated ,association.company.id " +
                "  from Store Store  left  join    Store.storeAssociations association where association.company.id = " +  companyId + "     "  +  ((Utils.isNull(whereCondition))?"":whereCondition) +
                " " + ((Utils.isNull(orderby))?"": (" order by " + orderby) ) );
        query.setFirstResult(from);
        query.setMaxResults(to-from);
        List<Object[]> ans = query.getResultList();
        List<PrimusModel> results = new ArrayList<>();
        if(!Utils.isNull(ans)) {
            ans.forEach( objects ->  {
                int id = Integer.parseInt(String.valueOf(objects[0]));
                String associatedCompany = String.valueOf(objects[7]);
               // if(Utils.isNullString(associatedCompany) ||associatedCompany.equalsIgnoreCase(String.valueOf(companyId)) ) {
                    String code = String.valueOf(objects[1]);
                    String name = String.valueOf(objects[2]);
                    String contactPerson = String.valueOf(objects[3]);
                    String city = String.valueOf(objects[4]);
                    String phone = String.valueOf(objects[5]);
                    String associated = String.valueOf(objects[6]);
                    Store uiStore = new Store();
                    uiStore.setId(id);
                    uiStore.setCode(code);
                    uiStore.setName(name);
                    uiStore.setContactPerson(contactPerson);
                    uiStore.setAddress(new Address());
                    uiStore.getAddress().setCity(city);
                    uiStore.getAddress().setPhone(phone);
                    uiStore.setAssociatedForCompany(Boolean.valueOf(associated));
                    results.add(uiStore);
                //}


            } );
        }

        return results;
    }*/

}

